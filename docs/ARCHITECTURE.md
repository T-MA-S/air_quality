# Архитектура системы

## Обзор

Система построена по принципу ETL (Extract, Transform, Load) с использованием витрины данных (Data Warehouse) для хранения и анализа информации о качестве воздуха и погоде.

## Диаграмма потоков данных

```
┌─────────────┐
│  OpenAQ API │
│  (Air Quality)│
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│  OpenAQ Client  │◄──┐
│  (Rate Limit,   │   │
│   Cache, Retry) │   │
└──────┬──────────┘   │
       │              │
       ▼              │
┌─────────────────┐  │
│  Transform      │  │
│  (Normalize,    │  │
│   Aggregate)    │  │
└──────┬──────────┘  │
       │              │
       ▼              │
┌─────────────────┐  │
│  Quality Check  │──┘
│  (Validation)   │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│  Data Warehouse │
│  (PostgreSQL)   │
│                 │
│  dim_city       │
│  dim_metric     │
│  fact_air_quality│
│  fact_weather   │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│   Dashboard     │
│   (Streamlit)   │
└─────────────────┘

┌─────────────┐
│Open-Meteo API│
│   (Weather)  │
└──────┬──────┘
       │
       ▼
┌─────────────────┐
│ Open-Meteo Client│
│  (Rate Limit,   │
│   Cache, Retry) │
└──────┬──────────┘
       │
       ▼
┌─────────────────┐
│  Transform      │
│  (Normalize)    │
└──────┬──────────┘
       │
       └──────────────┐
                      │
                      ▼
              ┌───────────────┐
              │ Merge AQ+Weather│
              └───────┬───────┘
                      │
                      ▼
              ┌───────────────┐
              │   Data Warehouse│
              └────────────────┘
```

## Компоненты системы

### 1. API Клиенты (`src/api/`)

**OpenAQ Client** (`openaq.py`):
- Извлечение данных о качестве воздуха
- Поддержка параметров: PM2.5, PM10, NO₂, O₃, CO, SO₂
- Rate limiting (100 запросов/минуту по умолчанию)
- Кэширование ответов (TTL: 1 час)
- Retry с экспоненциальной задержкой

**Open-Meteo Client** (`open_meteo.py`):
- Извлечение исторических и прогнозных метеоданных
- Параметры: температура, влажность, осадки, ветер
- Rate limiting (100 запросов/минуту)
- Кэширование ответов

### 2. Трансформация данных (`src/data/`)

**Модели данных** (`models.py`):
- Определение городов с координатами и часовыми поясами
- Валидация координат

**Трансформация** (`transform.py`):
- Нормализация временных меток (приведение к единому часовому поясу)
- Унификация единиц измерения (µg/m³)
- Агрегация данных по станциям в городах
- Склейка временных рядов воздуха и погоды

**Проверка качества** (`quality.py`):
- Проверка пропущенных значений (порог: 30%)
- Валидация диапазонов значений
- Проверка временной монотонности
- Обнаружение внезапных скачков (Z-score > 3)
- Проверка полноты данных по городам

### 3. База данных (`src/database/`)

**Схема данных** (`schema.py`):
- **dim_city**: Справочник городов (ID, название, страна, координаты, часовой пояс)
- **dim_metric**: Справочник метрик (ID, код, название, единица измерения)
- **fact_air_quality**: Факты о качестве воздуха (timestamp, city_id, metric_id, value, station_count)
- **fact_weather**: Факты о погоде (timestamp, city_id, температура, влажность, осадки, ветер)

**Загрузка данных** (`loader.py`):
- Загрузка городов в dim_city
- Загрузка фактов о качестве воздуха
- Загрузка фактов о погоде
- Bulk insert для производительности

**Представления** (`sql/views.sql`):
- `v_air_quality`: Воздух с названиями городов и метрик
- `v_weather`: Погода с названиями городов
- `v_air_quality_weather`: Объединенные данные
- `v_daily_aggregates`: Дневные агрегаты
- `v_moving_averages`: Скользящие средние (7 дней)
- `v_risk_map`: Карта рисков (превышения нормативов)

### 4. ETL Pipeline (`src/etl/`)

**Основной пайплайн** (`pipeline.py`):
1. **Extract**: Извлечение данных из API
2. **Transform**: Трансформация и нормализация
3. **Quality Check**: Проверка качества
4. **Load**: Загрузка в БД

Поддержка обработки множества городов параллельно.

### 5. Дашборд (`src/dashboard/`)

**Streamlit приложение** (`dashboard.py`):
- Фильтры: города, метрики, диапазон дат
- Вкладки:
  - **Trends**: Тренды PM2.5/PM10 по городам
  - **Correlations**: Матрица корреляций с метеопоказателями
  - **Risk Map**: Карта рисков по дням/часам
  - **Statistics**: Статистика и метрики качества

### 6. Оркестрация (`dags/`)

**Airflow DAG** (`air_quality_dag.py`):
- Запуск каждый час
- Задачи:
  1. `extract_and_load`: ETL процесс
  2. `validate_data_quality`: Валидация качества
  3. `create_views`: Создание представлений

### 7. ML Модель (`src/ml/`)

**PM2.5 Predictor** (`predictor.py`):
- Gradient Boosting Regressor
- Признаки: температура, влажность, осадки, ветер, PM10
- Backtesting на исторических данных
- Сохранение/загрузка модели

## Ключевые архитектурные решения

### 1. Витрина данных (Data Warehouse)

**Решение**: Использование схемы "звезда" (star schema) с факт-таблицами и справочниками.

**Обоснование**:
- Эффективные запросы для аналитики
- Легко добавлять новые города и метрики
- Поддержка временных рядов

### 2. Кэширование API ответов

**Решение**: Двухуровневое кэширование (файловое + память) с TTL.

**Обоснование**:
- Снижение нагрузки на API
- Ускорение разработки и тестирования
- Соблюдение rate limits

### 3. Проверка качества данных

**Решение**: Многоуровневая валидация на этапе трансформации.

**Обоснование**:
- Раннее обнаружение проблем
- Предотвращение загрузки некорректных данных
- Генерация отчетов о качестве

### 4. Контейнеризация

**Решение**: Docker и Docker Compose для всех компонентов.

**Обоснование**:
- Воспроизводимая среда разработки
- Легкое развертывание
- Изоляция зависимостей

### 5. Структурированное логирование

**Решение**: JSON логирование с уровнями.

**Обоснование**:
- Легкий парсинг и анализ
- Интеграция с системами мониторинга
- Отслеживание выполнения ETL

## Масштабируемость

- Горизонтальное масштабирование: добавление новых городов не требует изменений кода
- Вертикальное масштабирование: увеличение ресурсов БД для больших объемов данных
- Параллельная обработка: возможность обработки городов параллельно

## Безопасность

- Секреты через переменные окружения
- Нет хардкода API ключей
- Изоляция в Docker контейнерах

## Мониторинг и наблюдаемость

- Структурированные логи (JSON)
- Метрики выполнения ETL (количество записей, ошибки)
- Отчеты о качестве данных
- Airflow UI для мониторинга DAG

