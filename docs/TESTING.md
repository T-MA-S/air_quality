# Стратегия тестирования

## Обзор

Проект использует пирамиду тестов для обеспечения качества кода и данных:
- **Unit-тесты**: Тестирование отдельных компонентов (цель: ≥70% покрытия)
- **Интеграционные тесты**: Тестирование взаимодействия компонентов
- **End-to-End тесты**: Сквозные сценарии
- **Тесты качества данных**: Валидация схем, диапазонов, полноты

## Структура тестов

```
tests/
├── conftest.py              # Фикстуры pytest
├── test_api.py              # Тесты API клиентов
├── test_transform.py         # Тесты трансформации данных
├── test_quality.py           # Тесты проверки качества
├── test_integration.py       # Интеграционные тесты
└── test_ml.py                # Тесты ML моделей
```

## Unit-тесты

### API клиенты (`test_api.py`)

**Покрытие**:
- Инициализация клиентов
- Rate limiting
- Кэширование
- Обработка ошибок

**Примеры**:
```python
def test_client_initialization():
    client = OpenAQClient()
    assert client.base_url == "https://api.openaq.org/v2"

def test_rate_limiting():
    client = OpenAQClient(rate_limit=10)
    assert client.rate_limiter.max_requests == 10
```

### Трансформация данных (`test_transform.py`)

**Покрытие**:
- Нормализация временных меток
- Трансформация OpenAQ измерений
- Трансформация Open-Meteo данных
- Объединение данных

**Примеры**:
```python
def test_normalize_timestamp():
    dt = datetime(2024, 1, 1, 12, 0, 0)
    ts = normalize_timestamp(dt, "Europe/Moscow")
    assert ts.tz.zone == "Europe/Moscow"
```

### Проверка качества (`test_quality.py`)

**Покрытие**:
- Проверка пропущенных значений
- Валидация диапазонов
- Временная монотонность
- Обнаружение скачков
- Полнота данных

**Примеры**:
```python
def test_check_missing_values():
    df = pd.DataFrame({"col1": [1, 2, None, 4]})
    missing_ratios = checker.check_missing_values(df)
    assert missing_ratios["col1"] == 0.25
```

### ML модели (`test_ml.py`)

**Покрытие**:
- Инициализация модели
- Подготовка признаков
- Обучение
- Предсказания
- Сохранение/загрузка

## Интеграционные тесты

### ETL Pipeline (`test_integration.py`)

**Сценарии**:
1. Полный цикл ETL для одного города
2. Обработка множества городов
3. Обработка ошибок API
4. Валидация качества данных

**Моки**:
- API клиенты мокируются для избежания реальных запросов
- База данных может использовать тестовую БД

## End-to-End тесты

### Сквозной сценарий

**Описание**: Полный цикл от извлечения данных до отображения в дашборде.

**Шаги**:
1. Запуск ETL для тестового города
2. Проверка загрузки данных в БД
3. Проверка качества данных
4. Проверка доступности данных в представлениях
5. Проверка отображения в дашборде (опционально)

**Требования**:
- Тестовая БД
- Моки API или тестовые данные

## Тесты качества данных

### Валидация схемы

**Проверки**:
- Наличие обязательных полей
- Типы данных
- Ограничения (NOT NULL, UNIQUE, FOREIGN KEY)

### Валидация диапазонов

**Проверки**:
- PM2.5: 0-500 µg/m³
- PM10: 0-1000 µg/m³
- Температура: -50 до 50 °C
- Влажность: 0-100 %

### Проверка полноты

**Проверки**:
- Доля пропусков ≤ 30%
- Минимум 20 точек данных в день
- Полнота по городам и метрикам

### Проверка уникальности

**Проверки**:
- Уникальность (city_id, metric_id, timestamp) в fact_air_quality
- Уникальность (city_id, timestamp) в fact_weather

### Проверка свежести

**Проверки**:
- Последние данные не старше 24 часов
- Временная монотонность

### Проверка согласованности

**Проверки**:
- Согласованность координат между источниками
- Согласованность временных меток

## Автоматизация тестов

### Запуск тестов

```bash
# Все тесты
pytest

# С покрытием
pytest --cov=src --cov-report=html

# Конкретный файл
pytest tests/test_api.py

# Конкретный тест
pytest tests/test_api.py::TestOpenAQClient::test_client_initialization
```

### CI/CD интеграция

**GitHub Actions** (пример):
```yaml
name: Tests
on: [push, pull_request]
jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-python@v2
        with:
          python-version: '3.11'
      - run: pip install -r requirements.txt
      - run: pytest --cov=src --cov-report=xml
      - uses: codecov/codecov-action@v2
```

## Метрики покрытия

**Цель**: ≥70% покрытия кода unit-тестами

**Текущее покрытие** (пример):
- `src/api/`: 85%
- `src/data/`: 80%
- `src/database/`: 70%
- `src/etl/`: 65%
- `src/ml/`: 75%
- **Общее**: 73%

## Отчеты

### HTML отчет покрытия

```bash
pytest --cov=src --cov-report=html
# Открыть htmlcov/index.html
```

### Отчет о качестве данных

Генерируется автоматически при запуске ETL и сохраняется в логах.

**Содержание**:
- Доля пропусков по городам/метрикам
- Количество нарушений диапазонов
- Обнаруженные скачки
- Метрики полноты

## "Красные флаги"

Система генерирует предупреждения при:

1. **Пропуски данных** > 30%
2. **Значения вне диапазона** (например, PM2.5 > 500)
3. **Внезапные скачки** (Z-score > 3)
4. **Несвежие данные** (> 24 часов)
5. **Нарушение монотонности** времени
6. **Низкая полнота** (< 20 точек/день)

Эти предупреждения логируются и отображаются в Airflow UI.

## Тестовые данные

### Фикстуры (`conftest.py`)

- `sample_city`: Тестовый город
- `sample_air_quality_data`: Тестовые данные о воздухе
- `sample_weather_data`: Тестовые данные о погоде
- `quality_checker`: Экземпляр проверки качества

## Best Practices

1. **Изоляция**: Каждый тест независим
2. **Моки**: Использование моков для внешних API
3. **Фикстуры**: Переиспользование тестовых данных
4. **Параметризация**: Использование `@pytest.mark.parametrize` для множественных сценариев
5. **Чистка**: Очистка тестовых данных после тестов

## Планы на будущее

- [ ] Добавить тесты производительности
- [ ] Добавить нагрузочное тестирование API
- [ ] Автоматизация E2E тестов в CI/CD
- [ ] Интеграция с Great Expectations для более сложных проверок качества

